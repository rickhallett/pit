#!/usr/bin/env bash
# gate â€” Quality gate script for The Pit
# Exit 0 = ship. Exit non-zero = fix.

set -e

echo "ğŸšª GATE â€” Quality checks starting..."
echo ""

# Backend checks
echo "ğŸ Backend (Python)"
echo "==================="

cd "$(dirname "$0")/../be"

echo "â†’ Lint (ruff)..."
uv run ruff check src/ tests/ --fix

echo "â†’ Format (ruff)..."
uv run ruff format src/ tests/

echo "â†’ Type check (basic Python validation)..."
PYTHONPATH=src uv run python -c "import pit_api; print(f'  pit_api v{pit_api.__version__} OK')"

echo "â†’ Tests (pytest)..."
if compgen -G "tests/test_*.py" > /dev/null; then
    PYTHONPATH=src uv run pytest tests/ -v --tb=short
else
    echo "  (No test files found â€” skipping)"
fi

echo ""
echo "âœ… Backend checks passed"
echo ""

# Frontend checks (if fe directory has been scaffolded)
if [ -d "../fe/node_modules" ]; then
    echo "âš›ï¸  Frontend (Next.js)"
    echo "====================="
    
    cd ../fe
    
    echo "â†’ Lint (eslint)..."
    npm run lint
    
    echo "â†’ Type check (tsc)..."
    npm run type-check
    
    echo "â†’ Build..."
    npm run build
    
    echo ""
    echo "âœ… Frontend checks passed"
else
    echo "âš›ï¸  Frontend: Skipped (not scaffolded yet)"
fi

echo ""
echo "ğŸšª GATE PASSED â€” Ship it!"
